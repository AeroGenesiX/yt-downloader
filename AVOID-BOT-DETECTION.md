# Avoiding YouTube Bot Detection

This guide explains how to set up your YouTube downloader to avoid bot detection issues.

## Why Bot Detection Happens

YouTube uses various methods to detect automated downloads:
- Missing or invalid cookies
- Suspicious user-agent strings
- High request rates
- Missing browser headers
- Geographic location patterns

## Required: Set Up YouTube Cookies

**Cookies are ESSENTIAL** - without them, you'll almost certainly get bot detection errors.

### Step 1: Export Your YouTube Cookies

#### Method A: Browser Extension (Easiest)

1. **Install a cookie exporter extension**:
   - **Chrome/Edge**: Search for "Get cookies.txt LOCALLY" in the extension store
   - **Firefox**: Search for "cookies.txt" add-on

2. **Export cookies**:
   - Visit https://youtube.com (make sure you're logged in)
   - Click the extension icon
   - Select "Export" or "Download"
   - Choose "youtube.com" as the domain
   - Save the file as `youtube.txt`

3. **Verify the format**:
   Your file should look like this:
   ```
   # Netscape HTTP Cookie File
   # This file is generated by yt-dlp.  Do not edit.

   .youtube.com	TRUE	/	TRUE	1777867860	VISITOR_INFO1_LIVE	jxzMjFuKczk
   .youtube.com	TRUE	/	FALSE	0	PREF	f6=40000400&tz=UTC
   ```

#### Method B: Manual Export from Browser

**Chrome/Edge:**
1. Open YouTube (logged in)
2. Press F12 to open Developer Tools
3. Go to "Application" tab → "Cookies" → "https://youtube.com"
4. Copy all cookies manually (tedious, not recommended)

**Firefox:**
1. Open YouTube (logged in)
2. Press F12 to open Developer Tools
3. Go to "Storage" tab → "Cookies" → "https://youtube.com"
4. Copy all cookies manually

### Step 2: Set Up Cookies in Your Application

#### For Local Development:

```bash
# Move your exported cookie file to the project root
mv ~/Downloads/youtube.txt /home/aero/yt-downloader/

# Verify it's there
ls -la youtube.txt
```

The application will automatically detect and use `youtube.txt` in the project root directory.

#### For Production (Render.com):

**Option 1: Environment Variable (Works Everywhere)**

```bash
# In your terminal, encode the cookies file
base64 -w 0 cookies/youtube.txt > cookies_base64.txt

# Copy the output
cat cookies_base64.txt
```

Then on Render:
1. Go to your service dashboard
2. Click "Environment" in the left sidebar
3. Click "Add Environment Variable"
4. Key: `YOUTUBE_COOKIES_BASE64`
5. Value: [paste the base64 string]
6. Click "Save Changes"

**Option 2: Secret Files (Recommended for Render)**

1. Go to your Render service dashboard
2. Click "Environment" → "Secret Files"
3. Click "Add Secret File"
4. Set:
   - **Filename**: `youtube.txt`
   - **Contents**: [paste your entire cookies file]
5. Click "Save"
6. Redeploy your service

## Best Practices

### 1. Keep Cookies Fresh

YouTube cookies expire. You should:
- **Update cookies every 1-2 weeks** for best results
- Update immediately if you get bot detection errors
- Re-export after logging out/in to YouTube

### 2. Use a Real Google Account

- Don't use brand new accounts (they're flagged easily)
- Use an account with some watch history
- Ideally, use YouTube Premium account (less likely to be flagged)

### 3. Rate Limiting

The app now includes delays between requests:
- 1-3 seconds between requests
- Reduces likelihood of triggering rate limits

If you're getting blocked:
```python
# Edit downloader.py line 81-83 to increase delays:
'sleep_interval': 2,  # Increase from 1 to 2
'max_sleep_interval': 5,  # Increase from 3 to 5
```

### 4. Monitor for Errors

Check your application logs for these messages:

✅ **Good**:
```
✓ Cookies file found: /opt/render/project/src/youtube.txt
✓ Using cookies file: /opt/render/project/src/youtube.txt
```

❌ **Bad** (needs cookie update):
```
⚠ WARNING: Cookies file not found
Sign in to confirm you're not a bot
YouTube bot detection triggered
```

### 5. Geographic Considerations

If you're deploying on Render or similar:
- Some regions are more likely to be flagged
- Consider using a VPN or proxy if issues persist
- You can add proxy support in `downloader.py`:

```python
opts = {
    'proxy': 'http://your-proxy-server:port',
    # ... other options
}
```

## Troubleshooting

### Error: "Sign in to confirm you're not a bot"

**Solution**: Your cookies are missing or expired.
1. Export fresh cookies from your browser
2. Update the cookies file
3. Restart your application

### Error: "Video not available"

**Possible causes**:
1. Video is region-locked
2. Video is age-restricted (need cookies from signed-in account)
3. Video is private/members-only

**Solution**: Make sure your cookies are from a logged-in YouTube account with appropriate access.

### Downloads Work Locally But Not on Render

**Solution**: You forgot to set up cookies on Render.
1. Follow "For Production" steps above
2. Make sure the Secret File path is exactly: `youtube.txt`
3. Redeploy your service

## Testing Your Setup

### Local Test:

```bash
# Make sure you're in the project directory
cd /home/aero/yt-downloader

# Activate virtual environment
source yt-env/bin/activate

# Run a test
python -c "
from downloader import YouTubeDownloader
dl = YouTubeDownloader()
info = dl.get_video_info('https://www.youtube.com/watch?v=dQw4w9WgXcQ')
print(f'✓ Success! Video: {info[\"title\"]}')
"
```

If successful, you should see:
```
✓ Cookies file found: youtube.txt
✓ Using cookies file: youtube.txt
✓ Success! Video: [video title]
```

### Production Test:

After deploying to Render:
1. Open your application URL
2. Paste any YouTube URL
3. Click "Fetch Info"
4. If it works without errors, cookies are set up correctly!

## Security Notes

⚠️ **NEVER commit cookies to Git**

Your `.gitignore` should include:
```
youtube.txt
*.txt
```

⚠️ **Rotate cookies regularly**
- Treat cookies like passwords
- Update them if you suspect they're compromised
- Don't share your cookies file publicly

## Summary Checklist

- [ ] Exported YouTube cookies from browser
- [ ] Placed cookies in `youtube.txt` (local)
- [ ] OR set up `YT_COOKIES_B64` env variable (production)
- [ ] OR configured Secret Files on Render (production)
- [ ] Tested locally and saw "✓ Cookies file found" message
- [ ] Verified downloads work without bot detection errors
- [ ] Added `youtube.txt` to `.gitignore`
- [ ] Set reminder to update cookies in 2 weeks

## Need Help?

If you're still experiencing bot detection issues:

1. Check application logs for specific error messages
2. Verify cookies file format (should be Netscape format)
3. Try exporting cookies again from a different browser
4. Ensure your Google account isn't flagged/restricted
5. Consider using YouTube Premium account for better results

---

**Last Updated**: 2025-01-05
**Tested With**: yt-dlp latest, Python 3.13
